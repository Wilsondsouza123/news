<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pre-Market Dashboard â€” US Markets</title>
  <style>
    :root {
      --bg:#f6f7f9; --card:#fff; --border:#e3e6ea; --text:#222; --muted:#556;
      --btn-bg:#111; --btn-text:#fff; --btn-hover:#0b5cab; --btn-outline-bg:#fff; --btn-outline-text:#111;
      --pill-bg:#fff; --pill-border:#e3e6ea; --pill-text:#222;
      --modal-bg:rgba(0,0,0,0.5); --modal-card:var(--card); --modal-text:var(--text);
    }
    body.dark {
      --bg: #1a1c20; --card: #23252b; --border: #444;
      --text: #eaeaea; --muted: #bbb;
      --btn-bg:#222; --btn-text:#eee; --btn-hover:#295dcf; --btn-outline-bg:#222; --btn-outline-text:#fff;
      --pill-bg:#23252b; --pill-border:#444; --pill-text:#eee;
      --modal-card:#23252b; --modal-text:#eee;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      transition: background 0.2s, color 0.2s;
    }
    header {
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 18px; position:sticky; top:0;
      background:rgba(246,247,249,.95); border-bottom:1px solid var(--border);
      z-index:10;
    }
    body.dark header { background:rgba(30,32,36,.97);}
    h1 { font-size:18px; margin:0; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .btn {
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
      border:1px solid var(--border); background:var(--btn-bg); color:var(--btn-text);
      border-radius:10px; cursor:pointer; font-size:14px;
      transition: box-shadow 0.2s, background 0.2s, color 0.2s;
      outline: none;
    }
    .btn:focus { box-shadow: 0 0 0 2px #0b5cab55; }
    .btn:hover:not([disabled]) { box-shadow: 0 4px 12px rgba(11,92,171,0.12); background: var(--btn-hover); color: #fff;}
    .btn.outline {
      background:var(--btn-outline-bg); color:var(--btn-outline-text);
    }
    .btn.link {
      background:var(--btn-outline-bg); color:#0b5cab; border:1px dashed var(--border);
    }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .grid {
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:18px; padding:18px;
    }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.05); overflow:hidden;
      transition: background 0.2s, color 0.2s;
    }
    .card h2 {
      margin:0; padding:10px 12px; background:var(--btn-bg); color:var(--btn-text);
      font-size:15px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
    }
    .pad { padding:12px; }
    .muted { color:var(--muted); font-size:12px; }
    .rows { display:grid; gap:6px; }
    .row {
      display:flex; align-items:center; justify-content:space-between; padding:6px 8px;
      border:1px solid var(--border); border-radius:10px;
      cursor:pointer;
      transition: background 0.15s;
    }
    .row:hover { background:var(--btn-hover); color:#fff; }
    .row .sym { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .gain { color:#0a7a36; }
    .loss { color:#b42318; }
    .inputs { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input[type="text"], input[type="number"], input[type="password"], datalist {
      padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:14px;
      background:var(--card); color:var(--text);
      transition: background 0.2s, color 0.2s;
    }
    input:focus { outline:2px solid #0b5cab55; }
    .pill {
      padding:3px 8px; border:1px solid var(--pill-border); border-radius:999px;
      font-size:12px; background:var(--pill-bg); color:var(--pill-text);
    }
    #loading-spinner {
      display:none; text-align:center; padding:10px; color:var(--btn-hover);
    }
    /* Modal styles */
    #news-modal-bg {
      display:none; position:fixed; left:0; top:0; width:100vw; height:100vh;
      background:var(--modal-bg); z-index:1000;
      align-items:center; justify-content:center;
    }
    #news-modal-card {
      background:var(--modal-card); color:var(--modal-text);
      border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.15);
      max-width:480px; width:95vw; padding:18px; position:relative;
      border:1px solid var(--border);
      animation: fadein 0.2s;
    }
    @keyframes fadein {
      from { opacity:0; transform:translateY(20px);}
      to { opacity:1; transform:translateY(0);}
    }
    #news-close-btn {
      position:absolute; right:12px; top:12px; background:none; border:none; font-size:20px; cursor:pointer; color:var(--text);
    }
    #news-modal-card h3 { margin-top:0; }
    #news-list { margin:0; padding:0; list-style:none;}
    #news-list li { margin-bottom:10px; }
    #news-list a { color:#0b5cab;}
    #news-list a:hover { text-decoration: underline; }
    @media (max-width: 1100px) { .grid { grid-template-columns:1fr; } }
    @media (max-width: 700px) { header { flex-direction:column; gap:4px; } .pad, .card h2 { font-size:13px;} }
    table { width:100%; border-collapse: collapse; }
    thead th { background:var(--btn-bg); color:var(--btn-text); text-align:left; padding:10px; }
    td { border-top:1px solid var(--border); padding:10px; vertical-align: top; }
    tbody tr:hover { background:#fafafa; }
    body.dark tbody tr:hover { background:#23252b; }
    .linklist { list-style: none; padding-left: 0; margin: 0; }
    .linklist li { border-top:1px solid var(--border); padding:10px 0; }
    .linklist li:first-child { border-top: 0; }
    .linklist a { color:#0b5cab; text-decoration: none; }
    .linklist a:hover { text-decoration: underline; }
    #autocomplete-list {
      position: absolute; background:var(--card); border:1px solid var(--border); border-radius:8px;
      max-height:140px; overflow-y:auto; z-index:20;
      box-shadow:0 2px 12px rgba(0,0,0,.12);
    }
    #autocomplete-list div {
      padding:8px; cursor:pointer;
    }
    #autocomplete-list div:hover {
      background:var(--btn-hover); color:#fff;
    }
    .sort-controls { display:flex; gap:10px; align-items:center; margin-bottom:8px;}
    .sort-controls label { font-size:13px;}
    .sort-controls select, .sort-controls input { margin-left:4px; font-size:13px;}
  </style>
</head>
<body>
  <header>
    <h1>Pre-Market Dashboard â€” US Markets</h1>
    <div class="controls">
      <button class="btn" id="btn-refresh-agent" aria-label="Run Agent Now">Run Agent Now</button>
      <button class="btn outline" id="btn-autorefresh" aria-label="Toggle Auto-Refresh">Agent Auto-Refresh: OFF (2 min)</button>
      <button class="btn outline" id="toggle-dark" aria-label="Toggle Dark Mode">ðŸŒ— Theme</button>
      <span class="pill" id="last-run">Last agent run: â€”</span>
    </div>
  </header>

  <!-- ... TradingView widgets ... -->

  <!-- Agent row -->
  <div class="grid" style="grid-template-columns:1fr;">
    <div class="card">
      <h2>Agent â€” Watchlist Gainers â‰¥ +2% & Losers â‰¤ âˆ’2% (uses your API key)</h2>
      <div class="pad">
        <div class="inputs" style="margin-bottom:10px; position:relative;">
          <input id="api-key" type="password" placeholder="Finnhub API Key (optional)" style="min-width:180px;" aria-label="Finnhub API Key"/>
          <input id="symbols" type="text" placeholder="Watchlist: AAPL, MSFT, NVDA, TSLA, AMZN" style="min-width:180px;" aria-label="Watchlist Symbols" autocomplete="off"/>
          <div id="autocomplete-list"></div>
          <input id="interval" type="number" value="120" min="15" step="5" title="Seconds" aria-label="Refresh Interval"/>
          <button class="btn" id="run-agent" aria-label="Run/Refresh Agent">Run / Refresh</button>
          <button class="btn outline" id="save-watchlist" aria-label="Save Watchlist">ðŸ’¾ Save</button>
        </div>
        <div class="sort-controls">
          <label>Sort Gainers by:
            <select id="sort-gainers">
              <option value="percent">Percent</option>
              <option value="price">Price</option>
              <option value="symbol">Symbol</option>
            </select>
          </label>
          <label>Min Vol:
            <input id="filter-gainers-vol" type="number" min="0" style="width:60px;" placeholder="0"/>
          </label>
          <label>Sort Losers by:
            <select id="sort-losers">
              <option value="percent">Percent</option>
              <option value="price">Price</option>
              <option value="symbol">Symbol</option>
            </select>
          </label>
          <label>Min Vol:
            <input id="filter-losers-vol" type="number" min="0" style="width:60px;" placeholder="0"/>
          </label>
        </div>
        <div class="muted">Enter your API key and watchlist. Click a stock to view latest news!</div>
        <div id="loading-spinner">Loading...</div>
        <div class="rows" style="margin-top:12px;">
          <div>
            <div class="muted" style="margin-bottom:6px;">Gainers â‰¥ +2%</div>
            <div id="gainers" class="rows"></div>
          </div>
          <div style="margin-top:12px;">
            <div class="muted" style="margin-bottom:6px;">Losers â‰¤ âˆ’2%</div>
            <div id="losers" class="rows"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- News Modal -->
  <div id="news-modal-bg">
    <div id="news-modal-card">
      <button id="news-close-btn" aria-label="Close News">&times;</button>
      <h3 id="news-modal-title"></h3>
      <ul id="news-list"></ul>
      <div id="news-modal-msg" class="muted"></div>
    </div>
  </div>

  <!-- ... Education/Reference section ... -->

  <script>
    // ===== Theme Toggle and Persistent Theme =====
    const themeBtn = document.getElementById('toggle-dark');
    themeBtn.onclick = function() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark') ? '1' : '0');
    };
    if(localStorage.getItem('darkMode') === '1') document.body.classList.add('dark');

    // ===== Agent controls (â‰¥ Â±2%) =====
    const lastRun = document.getElementById('last-run');
    const autoBtn = document.getElementById('btn-autorefresh');
    const runBtn  = document.getElementById('btn-refresh-agent');
    const spinner = document.getElementById('loading-spinner');

    function stamp() {
      lastRun.textContent = 'Last agent run: ' + new Date().toLocaleTimeString();
    }
    function showSpinner(show) { spinner.style.display = show ? 'block' : 'none'; }

    async function fetchFinnhubQuote(symbol, key){
      const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${key}`;
      try {
        const res = await fetch(url);
        if(!res.ok) throw new Error('Finnhub error for ' + symbol);
        const d = await res.json();
        // For demo, use random volume
        return { symbol, price: d.c, percent: d.dp, volume: d.v || Math.floor(1000+Math.random()*50000) };
      } catch (e) {
        return { symbol, error: true };
      }
    }

    let gainersData = [], losersData = [];

    function sortRows(data, sortType, minVol) {
      let filtered = data.filter(x => (minVol ? x.volume >= minVol : true));
      if(sortType === 'percent') filtered.sort((a,b)=>b.percent-a.percent);
      if(sortType === 'price') filtered.sort((a,b)=>b.price-a.price);
      if(sortType === 'symbol') filtered.sort((a,b)=>a.symbol.localeCompare(b.symbol));
      return filtered;
    }

    function renderRows(data, el, type) {
      el.innerHTML = '';
      if(!data.length) {
        el.appendChild(row('No '+type+' in watchlist.', 'muted'));
        return;
      }
      data.forEach(x=>{
        el.appendChild(row(
          `<span class="sym">${x.symbol}</span>
           <span class="${type==='gainers'?'gain':'loss'}">${x.percent>0?'+':''}${x.percent.toFixed(2)}%</span>
           <span>${Number(x.price).toFixed(2)}</span>
           <span>${x.volume}</span>`, type==='gainers'?'gain':'loss', x.symbol
        ));
      });
    }

    function row(html, cls='', symbol='') {
      const el = document.createElement('div');
      el.className = 'row ' + cls;
      el.innerHTML = html;
      if(symbol) el.setAttribute('data-symbol', symbol);
      return el;
    }

    async function runAgentOnce(){
      const key = document.getElementById('api-key').value.trim();
      const syms = document.getElementById('symbols').value.trim();
      const gainersBox = document.getElementById('gainers');
      const losersBox  = document.getElementById('losers');
      gainersBox.innerHTML = '';
      losersBox.innerHTML  = '';
      showSpinner(true);

      if(!key || !syms){
        const msg = document.createElement('div');
        msg.className = 'muted';
        msg.textContent = 'Enter API key and symbols to fetch filtered movers.';
        gainersBox.appendChild(msg.cloneNode(true));
        losersBox.appendChild(msg);
        showSpinner(false);
        return;
      }

      const symbols = syms.split(/[\s,]+/).map(s=>s.trim().toUpperCase()).filter(Boolean);
      const results = await Promise.allSettled(symbols.map(s=>fetchFinnhubQuote(s, key)));
      const ok = results.filter(r=>r.status==='fulfilled').map(r=>r.value);

      // Sorting/filtering controls
      const gainSortType = document.getElementById('sort-gainers').value;
      const gainMinVol = Number(document.getElementById('filter-gainers-vol').value)||0;
      const lossSortType = document.getElementById('sort-losers').value;
      const lossMinVol = Number(document.getElementById('filter-losers-vol').value)||0;

      gainersData = ok.filter(x=>!x.error && x.percent >=  2);
      losersData  = ok.filter(x=>!x.error && x.percent <= -2);

      const sortedGainers = sortRows(gainersData, gainSortType, gainMinVol);
      const sortedLosers  = sortRows(losersData,  lossSortType, lossMinVol);

      renderRows(sortedGainers, gainersBox, 'gainers');
      renderRows(sortedLosers, losersBox, 'losers');

      showSpinner(false);
      stamp();
    }

    let agentTimer = null;
    document.getElementById('run-agent').addEventListener('click', async ()=>{
      const seconds = Math.max(15, Number(document.getElementById('interval').value||120));
      if(agentTimer) clearInterval(agentTimer);
      await runAgentOnce();
      agentTimer = setInterval(runAgentOnce, seconds*1000);
    });
    runBtn.addEventListener('click', runAgentOnce);

    let autoOn = false;
    autoBtn.addEventListener('click', ()=>{
      autoOn = !autoOn;
      if (autoOn) {
        autoBtn.textContent = 'Agent Auto-Refresh: ON (2 min)';
        if (agentTimer) clearInterval(agentTimer);
        agentTimer = setInterval(runAgentOnce, 120000);
        runAgentOnce();
      } else {
        autoBtn.textContent = 'Agent Auto-Refresh: OFF (2 min)';
        if (agentTimer) clearInterval(agentTimer);
      }
    });

    // initial stamp
    stamp();

    // ===== Persistent Watchlist =====
    const symbolsInput = document.getElementById('symbols');
    const saveWatchlistBtn = document.getElementById('save-watchlist');
    if(localStorage.getItem('watchlistSyms')){
      symbolsInput.value = localStorage.getItem('watchlistSyms');
    }
    saveWatchlistBtn.onclick = function(){
      localStorage.setItem('watchlistSyms', symbolsInput.value.trim());
      saveWatchlistBtn.textContent = "âœ… Saved";
      setTimeout(()=>saveWatchlistBtn.textContent="ðŸ’¾ Save",1000);
    };

    // ===== Symbol Autocomplete (basic static) =====
    const STOCK_SYMBOLS = ["AAPL","MSFT","NVDA","TSLA","AMZN","GOOGL","META","GOOG","NFLX","AMD","INTC","BA","BABA","CRM","JPM","BAC","V","MA","DIS"];
    let autocompleteList = document.getElementById("autocomplete-list");
    symbolsInput.addEventListener("input", function(e) {
      const val = this.value.split(/[\s,]+/).pop().toUpperCase();
      autocompleteList.innerHTML = "";
      if (!val) return false;
      STOCK_SYMBOLS.filter(s=>s.startsWith(val)).forEach(s=>{
        const div = document.createElement("div");
        div.textContent = s;
        div.onclick = () => {
          let syms = symbolsInput.value.split(/[\s,]+/);
          syms.pop();
          syms.push(s);
          symbolsInput.value = syms.join(", ");
          autocompleteList.innerHTML = "";
        };
        autocompleteList.appendChild(div);
      });
    });
    symbolsInput.addEventListener("blur",()=>setTimeout(()=>autocompleteList.innerHTML="",200));

    // ===== Sorting/Filtering events =====
    document.getElementById('sort-gainers').addEventListener('change', ()=>renderRows(sortRows(gainersData,
      document.getElementById('sort-gainers').value, Number(document.getElementById('filter-gainers-vol').value)||0),
      document.getElementById('gainers'),'gainers'));
    document.getElementById('filter-gainers-vol').addEventListener('input', ()=>renderRows(sortRows(gainersData,
      document.getElementById('sort-gainers').value, Number(document.getElementById('filter-gainers-vol').value)||0),
      document.getElementById('gainers'),'gainers'));
    document.getElementById('sort-losers').addEventListener('change', ()=>renderRows(sortRows(losersData,
      document.getElementById('sort-losers').value, Number(document.getElementById('filter-losers-vol').value)||0),
      document.getElementById('losers'),'losers'));
    document.getElementById('filter-losers-vol').addEventListener('input', ()=>renderRows(sortRows(losersData,
      document.getElementById('sort-losers').value, Number(document.getElementById('filter-losers-vol').value)||0),
      document.getElementById('losers'),'losers'));

    // ===== News Modal =====
    const newsModalBg = document.getElementById('news-modal-bg');
    const newsModalCard = document.getElementById('news-modal-card');
    const newsCloseBtn = document.getElementById('news-close-btn');
    const newsTitle = document.getElementById('news-modal-title');
    const newsList = document.getElementById('news-list');
    const newsMsg = document.getElementById('news-modal-msg');

    function showNewsModal(symbol) {
      newsModalBg.style.display = 'flex';
      newsTitle.textContent = `Latest News: ${symbol}`;
      newsList.innerHTML = '';
      newsMsg.textContent = 'Loading...';

      // Try Yahoo Finance RSS (CORS may block, demo fallback to MarketWatch headlines)
      fetch(`https://feeds.finance.yahoo.com/rss/2.0/headline?s=${symbol}&region=US&lang=en-US`)
        .then(r=>r.text())
        .then(xml=>{
          // Parse RSS
          let parser = new DOMParser();
          let doc = parser.parseFromString(xml, "application/xml");
          let items = Array.from(doc.querySelectorAll('item')).slice(0,5);
          if(items.length) {
            newsList.innerHTML = '';
            items.forEach(it=>{
              let li = document.createElement('li');
              li.innerHTML = `<a href="${it.querySelector('link').textContent}" target="_blank">${it.querySelector('title').textContent}</a>`;
              newsList.appendChild(li);
            });
            newsMsg.textContent = '';
          } else {
            newsMsg.textContent = 'No news found. Try MarketWatch or Google News.';
          }
        })
        .catch(()=>{
          // Fallback: MarketWatch headlines (no RSS, so just link out)
          newsList.innerHTML = `<li><a href="https://www.marketwatch.com/investing/stock/${symbol.toLowerCase()}" target="_blank">See headlines for ${symbol} on MarketWatch</a></li>`;
          newsMsg.textContent = 'News feed failed (likely CORS). See MarketWatch link above.';
        });
    }
    newsCloseBtn.onclick = ()=>newsModalBg.style.display='none';
    newsModalBg.onclick = e => { if(e.target===newsModalBg) newsModalBg.style.display='none'; }
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') newsModalBg.style.display='none'; });

    // Attach click event to rows (gainers/losers)
    function attachNewsEvents() {
      ['gainers','losers'].forEach(type=>{
        document.getElementById(type).addEventListener('click',function(e){
          let row = e.target.closest('.row[data-symbol]');
          if(row) showNewsModal(row.getAttribute('data-symbol'));
        });
      });
    }
    // Attach after every agent run
    (function watcher(){
      setInterval(attachNewsEvents,1000);
    })();

    // Accessibility: Focus outlines for buttons, inputs, ARIA labels set
  </script>
</body>
</html>
